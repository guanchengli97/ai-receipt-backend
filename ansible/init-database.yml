---
- name: Initialize database schema
  hosts: "{{ target_hosts | default('all') }}"
  vars_files:
    - vars/vault.yml
    - vars/main.yml

  tasks:
    - name: Create database initialization SQL script
      copy:
        content: |
          -- Create tables for AI Receipt Backend
          
          CREATE TABLE IF NOT EXISTS `users` (
            `id` BIGINT NOT NULL AUTO_INCREMENT,
            `username` VARCHAR(50) NOT NULL UNIQUE,
            `email` VARCHAR(100) NOT NULL UNIQUE,
            `password` VARCHAR(255) NOT NULL,
            `is_active` BOOLEAN DEFAULT TRUE,
            `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            PRIMARY KEY (`id`),
            INDEX `idx_username` (`username`),
            INDEX `idx_email` (`email`),
            INDEX `idx_created_at` (`created_at`)
          ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
          
          CREATE TABLE IF NOT EXISTS `receipts` (
            `id` BIGINT NOT NULL AUTO_INCREMENT,
            `user_id` BIGINT NOT NULL,
            `receipt_number` VARCHAR(100) UNIQUE,
            `amount` DECIMAL(10, 2) NOT NULL,
            `currency` VARCHAR(3) DEFAULT 'USD',
            `merchant_name` VARCHAR(255),
            `receipt_date` DATE,
            `description` TEXT,
            `image_path` VARCHAR(255),
            `status` VARCHAR(20) DEFAULT 'PENDING',
            `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            `updated_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
            PRIMARY KEY (`id`),
            FOREIGN KEY (`user_id`) REFERENCES `users`(`id`) ON DELETE CASCADE,
            INDEX `idx_user_id` (`user_id`),
            INDEX `idx_status` (`status`),
            INDEX `idx_created_at` (`created_at`)
          ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
          
          CREATE TABLE IF NOT EXISTS `audit_logs` (
            `id` BIGINT NOT NULL AUTO_INCREMENT,
            `user_id` BIGINT,
            `action` VARCHAR(50) NOT NULL,
            `entity_type` VARCHAR(50),
            `entity_id` BIGINT,
            `details` JSON,
            `ip_address` VARCHAR(45),
            `user_agent` TEXT,
            `created_at` TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            PRIMARY KEY (`id`),
            FOREIGN KEY (`user_id`) REFERENCES `users`(`id`) ON DELETE SET NULL,
            INDEX `idx_user_id` (`user_id`),
            INDEX `idx_action` (`action`),
            INDEX `idx_created_at` (`created_at`)
          ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
          
          -- Insert sample data
          INSERT IGNORE INTO `users` (username, email, password) VALUES
          ('admin', 'admin@example.com', '$2a$10$slYQmyNdGzin7olVSCkCOOjvMEHZYqHwNZWGWkE7F2nWb7w4bMkWS'),
          ('testuser', 'test@example.com', '$2a$10$slYQmyNdGzin7olVSCkCOOjvMEHZYqHwNZWGWkE7F2nWb7w4bMkWS');
          
          -- Create indexes for performance
          COMMIT;
        dest: /tmp/init_database.sql
      register: sql_script_created

    - name: Execute database initialization script
      mysql_query:
        login_db: "{{ db_name }}"
        query: "{{ lookup('file', '/tmp/init_database.sql') }}"
      ignore_errors: yes

    - name: Remove temporary SQL script
      file:
        path: /tmp/init_database.sql
        state: absent
