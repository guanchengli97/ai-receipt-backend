# Ansible éƒ¨ç½²æ¶æ„å’Œæµç¨‹è¯´æ˜

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Ansible Control Node                   â”‚
â”‚              (Your Local Machine / CI/CD Server)         â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Ansible Playbook (deploy.yml)                   â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ roles/mysql/tasks/main.yml                  â”‚   â”‚
â”‚  â”‚  â””â”€â”€ roles/java-app/tasks/main.yml               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                         â”‚                                â”‚
â”‚                         â”‚ SSH/Ansible Protocol          â”‚
â”‚                         â†“                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                 â”‚                 â”‚
        â†“                 â†“                 â†“
    
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Target Server(s)                           â”‚
â”‚         (Ubuntu/Debian/CentOS/RHEL)                      â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  MySQL Server (Port 3306)                       â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ ai_receipt_db (Database)                   â”‚   â”‚
â”‚  â”‚  â””â”€â”€ receipt_user (Application User)            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Java Application (Spring Boot)                 â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ Port: 8080                                 â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ Context: /api                              â”‚   â”‚
â”‚  â”‚  â””â”€â”€ Service: ai-receipt-backend                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  systemd Services                               â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ mysql (Auto-start)                         â”‚   â”‚
â”‚  â”‚  â””â”€â”€ ai-receipt-backend (Auto-start)            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Logs & Monitoring                              â”‚   â”‚
â”‚  â”‚  â”œâ”€â”€ /opt/ai-receipt-backend/logs/app.log      â”‚   â”‚
â”‚  â”‚  â””â”€â”€ journalctl -u ai-receipt-backend           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“‹ éƒ¨ç½²æµç¨‹

### ç¬¬ä¸€æ­¥ï¼šå‰ç½®æ£€æŸ¥
```
1. éªŒè¯ Ansible å®‰è£…
2. æ£€æŸ¥ç›®æ ‡æœåŠ¡å™¨è¿æ¥
3. éªŒè¯ SSH å¯†é’¥æˆ–å¯†ç 
4. æ”¶é›†ç›®æ ‡æœåŠ¡å™¨ä¿¡æ¯ (gather_facts)
```

### ç¬¬äºŒæ­¥ï¼šMySQL å®‰è£…ä¸é…ç½®

```
MySQL Role æ‰§è¡Œæµç¨‹ï¼š
â”œâ”€â”€ æ›´æ–°åŒ…ç®¡ç†å™¨
â”œâ”€â”€ å®‰è£… MySQL æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯
â”œâ”€â”€ å¯åŠ¨ MySQL æœåŠ¡
â”œâ”€â”€ åˆ›å»ºåº”ç”¨æ•°æ®åº“ (ai_receipt_db)
â”œâ”€â”€ åˆ›å»ºåº”ç”¨ç”¨æˆ· (receipt_user)
â”œâ”€â”€ é…ç½®ç”¨æˆ·æƒé™
â”œâ”€â”€ é…ç½® MySQL è¿œç¨‹è®¿é—®ï¼ˆå¯é€‰ï¼‰
â””â”€â”€ åˆå§‹åŒ–æ•°æ®åº“è¡¨ç»“æ„
```

### ç¬¬ä¸‰æ­¥ï¼šJava åº”ç”¨éƒ¨ç½²

```
Java App Role æ‰§è¡Œæµç¨‹ï¼š
â”œâ”€â”€ åˆ›å»ºåº”ç”¨ç”¨æˆ·å’Œç»„
â”œâ”€â”€ å®‰è£… Java è¿è¡Œæ—¶ (OpenJDK 11)
â”œâ”€â”€ å®‰è£… Maven æ„å»ºå·¥å…·
â”œâ”€â”€ åˆ›å»ºåº”ç”¨ç›®å½•
â”œâ”€â”€ å¤åˆ¶åº”ç”¨æºä»£ç 
â”œâ”€â”€ ä½¿ç”¨ Maven ç¼–è¯‘æ‰“åŒ…
â”œâ”€â”€ ç”Ÿæˆ application.yml é…ç½®æ–‡ä»¶
â”œâ”€â”€ åˆ›å»º systemd æœåŠ¡æ–‡ä»¶
â”œâ”€â”€ å¯åŠ¨åº”ç”¨æœåŠ¡
â””â”€â”€ éªŒè¯åº”ç”¨å¥åº·çŠ¶æ€
```

## ğŸ”„ å·¥ä½œæµç¨‹è¯¦è§£

### 1. åˆå§‹åŒ–é˜¶æ®µ

```yaml
- name: Update package cache
  apt:
    update_cache: yes
    cache_valid_time: 3600
```

**ä½œç”¨**ï¼šæ›´æ–°ç³»ç»ŸåŒ…ç´¢å¼•ï¼Œç¡®ä¿å®‰è£…æœ€æ–°ç‰ˆæœ¬

### 2. å®‰è£…é˜¶æ®µ

```yaml
- name: Install MySQL server and client
  apt:
    name:
      - mysql-server
      - mysql-client
      - python3-pymysql
    state: present
```

**ä½œç”¨**ï¼šå®‰è£…å¿…è¦çš„ç³»ç»ŸåŒ…

### 3. é…ç½®é˜¶æ®µ

```yaml
- name: Create MySQL database
  mysql_db:
    name: "{{ db_name }}"
    state: present
```

**ä½œç”¨**ï¼šåˆ›å»ºæ•°æ®åº“ã€ç”¨æˆ·ï¼Œé…ç½®æƒé™

### 4. éƒ¨ç½²é˜¶æ®µ

```yaml
- name: Build application with Maven
  shell: |
    cd {{ app_home }}/src
    mvn clean package -DskipTests
```

**ä½œç”¨**ï¼šç¼–è¯‘ Java åº”ç”¨å¹¶ç”Ÿæˆ JAR åŒ…

### 5. æœåŠ¡åŒ–é˜¶æ®µ

```yaml
- name: Enable and start Java application service
  systemd:
    name: ai-receipt-backend
    state: started
    enabled: yes
```

**ä½œç”¨**ï¼šå°†åº”ç”¨æ³¨å†Œä¸ºç³»ç»ŸæœåŠ¡ï¼Œå¼€æœºè‡ªå¯

### 6. éªŒè¯é˜¶æ®µ

```yaml
- name: Verify application is running
  uri:
    url: "http://localhost:8080/api/health"
    method: GET
    status_code: 200
```

**ä½œç”¨**ï¼šæ£€æŸ¥åº”ç”¨æ˜¯å¦æˆåŠŸå¯åŠ¨

## ğŸ“Š æ–‡ä»¶è·¯å¾„æ˜ å°„

| ç»„ä»¶ | è·¯å¾„ | æè¿° |
|-----|------|------|
| MySQL | `/var/lib/mysql` | æ•°æ®å­˜å‚¨ç›®å½• |
| MySQL é…ç½® | `/etc/mysql/mysql.conf.d/mysqld.cnf` | é…ç½®æ–‡ä»¶ |
| MySQL æ—¥å¿— | `/var/log/mysql/error.log` | é”™è¯¯æ—¥å¿— |
| åº”ç”¨ç›®å½• | `/opt/ai-receipt-backend` | åº”ç”¨å®‰è£…ç›®å½• |
| åº”ç”¨ JAR | `/opt/ai-receipt-backend/ai-receipt-backend.jar` | åº”ç”¨ç¨‹åº |
| åº”ç”¨é…ç½® | `/opt/ai-receipt-backend/config/application.yml` | é…ç½®æ–‡ä»¶ |
| åº”ç”¨æ—¥å¿— | `/opt/ai-receipt-backend/logs/app.log` | åº”ç”¨æ—¥å¿— |
| systemd æœåŠ¡ | `/etc/systemd/system/ai-receipt-backend.service` | æœåŠ¡æ–‡ä»¶ |

## ğŸ” æƒé™ç®¡ç†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç”¨æˆ·/ç»„         â”‚ æƒé™         â”‚ ç”¨é€”            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ mysql:mysql     â”‚ 755          â”‚ MySQL æ•°æ®åº“    â”‚
â”‚ appuser:appgroupâ”‚ 755          â”‚ Java åº”ç”¨       â”‚
â”‚ root:root       â”‚ 644          â”‚ æœåŠ¡é…ç½®æ–‡ä»¶    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ˆ éƒ¨ç½²æ—¶é—´ä¼°è®¡

| æ“ä½œ | é¢„è®¡æ—¶é—´ |
|-----|---------|
| MySQL å®‰è£…ä¸é…ç½® | 2-3 åˆ†é’Ÿ |
| Java ç¼–è¯‘ | 3-5 åˆ†é’Ÿ |
| åº”ç”¨å¯åŠ¨ | 1-2 åˆ†é’Ÿ |
| **æ€»è®¡** | **6-10 åˆ†é’Ÿ** |

## ğŸ”„ æ›´æ–°å’Œå›æ»š

### åº”ç”¨æ›´æ–°æµç¨‹

```bash
# 1. åœæ­¢åº”ç”¨
sudo systemctl stop ai-receipt-backend

# 2. å¤‡ä»½å½“å‰ç‰ˆæœ¬
sudo cp /opt/ai-receipt-backend/ai-receipt-backend.jar \
        /opt/ai-receipt-backend/ai-receipt-backend-v1.0.jar

# 3. æ„å»ºæ–°ç‰ˆæœ¬
mvn clean package -DskipTests

# 4. æ›¿æ¢ JAR æ–‡ä»¶
sudo cp target/ai-receipt-backend-0.0.1-SNAPSHOT.jar \
        /opt/ai-receipt-backend/ai-receipt-backend.jar

# 5. å¯åŠ¨åº”ç”¨
sudo systemctl start ai-receipt-backend
```

### å›æ»šæ­¥éª¤

```bash
# 1. åœæ­¢åº”ç”¨
sudo systemctl stop ai-receipt-backend

# 2. æ¢å¤å¤‡ä»½ç‰ˆæœ¬
sudo cp /opt/ai-receipt-backend/ai-receipt-backend-v1.0.jar \
        /opt/ai-receipt-backend/ai-receipt-backend.jar

# 3. å¯åŠ¨åº”ç”¨
sudo systemctl start ai-receipt-backend

# 4. éªŒè¯
curl http://localhost:8080/api/health
```

## âš ï¸ æ•…éšœæ’æŸ¥æµç¨‹

```
é—®é¢˜å‘ç”Ÿ
    â†“
[Step 1] æ£€æŸ¥è¿æ¥
  - ping ç›®æ ‡æœåŠ¡å™¨
  - æµ‹è¯• SSH è¿æ¥
    â†“
[Step 2] æ£€æŸ¥æœåŠ¡çŠ¶æ€
  - sudo systemctl status mysql
  - sudo systemctl status ai-receipt-backend
    â†“
[Step 3] æŸ¥çœ‹æ—¥å¿—
  - åº”ç”¨æ—¥å¿—: tail -f /opt/ai-receipt-backend/logs/app.log
  - MySQL æ—¥å¿—: sudo tail -f /var/log/mysql/error.log
  - systemd æ—¥å¿—: journalctl -u ai-receipt-backend -f
    â†“
[Step 4] æ£€æŸ¥ç½‘ç»œå’Œç«¯å£
  - sudo netstat -tlnp | grep -E '3306|8080'
  - sudo firewall-cmd --list-all
    â†“
[Step 5] éªŒè¯é…ç½®
  - æ£€æŸ¥ application.yml é…ç½®
  - éªŒè¯æ•°æ®åº“å‡­è¯
  - æ£€æŸ¥ JWT å¯†é’¥
    â†“
[è§£å†³] åº”ç”¨è§£å†³æ–¹æ¡ˆæˆ–å›æ»š
```

## ğŸš€ æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **å †å†…å­˜è°ƒä¼˜**
   ```bash
   # åœ¨ /etc/systemd/system/ai-receipt-backend.service ä¸­
   ExecStart=/usr/bin/java -Xms2g -Xmx4g -XX:+UseG1GC
   ```

2. **æ•°æ®åº“è¿æ¥æ± **
   ```yaml
   # application.yml
   spring:
     datasource:
       hikari:
         maximum-pool-size: 20
         minimum-idle: 5
   ```

3. **MySQL ä¼˜åŒ–**
   ```mysql
   -- åˆ›å»ºå¿…è¦çš„ç´¢å¼•
   CREATE INDEX idx_user_id ON receipts(user_id);
   CREATE INDEX idx_created_at ON receipts(created_at);
   ```

## ğŸ“ æ”¯æŒå’Œé—®é¢˜åé¦ˆ

é‡åˆ°é—®é¢˜æ—¶ï¼Œè¯·æ”¶é›†ä»¥ä¸‹ä¿¡æ¯ï¼š
1. Ansible ç‰ˆæœ¬
2. ç›®æ ‡æœåŠ¡å™¨ OS å’Œç‰ˆæœ¬
3. å®Œæ•´é”™è¯¯æ—¥å¿—ï¼ˆä½¿ç”¨ `-vvv` é€‰é¡¹ï¼‰
4. ç›®æ ‡æœåŠ¡å™¨çš„ç³»ç»Ÿä¿¡æ¯
